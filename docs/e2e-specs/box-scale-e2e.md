# E2Eテスト仕様書: BOX API連携 + 1,050人スケーラビリティ

## テストケース一覧（8項目）

| ID | シナリオ | フロー内容 | 期待結果 |
|----|---------|-----------|---------|
| E2E-BOX-001 | BOXダイアログ表示・フォルダブラウズ | ログイン→ナレッジ管理→BOXから同期ボタン→ダイアログ | フォルダ一覧が表示される |
| E2E-BOX-002 | ファイル選択・同期実行フロー | フォルダ選択→ファイル選択→同期実行 | 同期完了→ドキュメント一覧に追加 |
| E2E-BOX-003 | 同期済みドキュメントの更新フロー | 既存BOXドキュメント→再同期 | 旧チャンク削除→新チャンク生成→synced状態 |
| E2E-BOX-004 | BOX未設定時のUI非表示 | BOX環境変数なし→ナレッジ管理画面 | 「BOXから同期」ボタンが表示されない |
| E2E-BOX-005 | Webhook受信→自動同期フロー | Webhook POST→署名検証→自動同期 | ドキュメントが自動更新される |
| E2E-SCALE-001 | 負荷テスト50人同時 | Locust 50ユーザー | P95 < 3秒、エラー率 < 1% |
| E2E-SCALE-002 | 負荷テスト100人同時 | Locust 100ユーザー | P95 < 3秒、エラー率 < 1% |
| E2E-SCALE-003 | 負荷テスト1,050人同時 | Locust 1,050ユーザー | P95 < 3秒、エラー率 < 1% |

---

## 詳細シナリオ

### E2E-BOX-001: BOXダイアログ表示・フォルダブラウズ

**前提条件**:
- 管理者アカウントでログイン済み
- BOX環境変数が設定済み（BOX_CLIENT_ID等）
- BOXサンドボックス環境にテスト用フォルダが存在

**操作手順**:
1. /admin/documents に遷移
2. 「BOXから同期」ボタンをクリック
3. BOX同期ダイアログが表示される
4. ルートフォルダ（id=0）のサブフォルダ一覧が表示される
5. フォルダをクリックして下位フォルダに遷移
6. 「戻る」ボタンで親フォルダに戻る

**期待結果**:
- ダイアログにフォルダ名が表示される
- フォルダアイコン付きで階層ナビゲーション可能
- 空フォルダの場合は「ファイルがありません」表示

**検証ポイント**:
- フォルダ一覧APIが正常に応答する
- フォルダ名、アイテム数が正しく表示される

---

### E2E-BOX-002: ファイル選択・同期実行フロー

**前提条件**:
- E2E-BOX-001 完了状態
- テスト用PDFファイルがBOXフォルダに存在

**操作手順**:
1. ファイルが存在するフォルダに遷移
2. ファイル一覧が表示される（名前、サイズ、更新日時、形式）
3. 同期したいファイルのチェックボックスをON
4. 公開範囲を設定（全社公開 or 部門指定）
5. 「同期実行」ボタンをクリック
6. 同期進捗表示（処理中...）
7. 同期完了通知

**期待結果**:
- ダイアログが閉じる
- ドキュメント一覧に新規ドキュメントが追加される
- ファイル名、チャンク数が正しい
- graph_build_status が pending → building → completed に遷移

**検証ポイント**:
- DocumentテーブルにboxFileIdが保存されている
- DocumentChunkが正しく生成されている
- 部門割当が反映されている

---

### E2E-BOX-003: 同期済みドキュメントの更新フロー

**前提条件**:
- E2E-BOX-002 で同期済みのドキュメントが存在
- BOX上で対象ファイルの内容を更新済み

**操作手順**:
1. BOXダイアログを開く
2. 同期済みファイルがあるフォルダに遷移
3. 同期済みファイルを選択（「同期済み」バッジ表示）
4. 「再同期」ボタンをクリック
5. 更新確認ダイアログで「はい」

**期待結果**:
- 旧チャンクが削除される
- 新しい内容でチャンクが再生成される
- box_sync_status が synced に更新
- box_synced_at が更新される

**検証ポイント**:
- チャンク内容が新しいファイル内容を反映している
- ドキュメントIDは変わらない（更新であって新規作成ではない）

---

### E2E-BOX-004: BOX未設定時のUI非表示

**前提条件**:
- BOX環境変数が空 or 未設定

**操作手順**:
1. /admin/documents に遷移
2. ページ全体を確認

**期待結果**:
- 「BOXから同期」ボタンが表示されない
- 手動アップロード機能は正常に動作する
- エラーは発生しない

**検証ポイント**:
- BOX設定確認APIが false を返す
- UIがBOX連携セクションを非表示にする

---

### E2E-BOX-005: Webhook受信→自動同期フロー

**前提条件**:
- Webhookが登録済み
- BOXサンドボックス環境が利用可能

**操作手順**:
1. BOXにテスト用ファイルをアップロード（またはWebhookエンドポイントに直接POST）
2. Webhookペイロードが送信される
3. バックエンドが署名検証を実行
4. 自動同期が開始

**期待結果**:
- ドキュメントが自動的にDBに保存される
- チャンク・エンベディングが生成される
- 管理画面をリロードすると新ドキュメントが表示される

**検証ポイント**:
- 署名検証が正しく動作する（不正署名は拒否）
- 重複ファイルは更新として処理される

---

### E2E-SCALE-001: 負荷テスト 50人同時

**前提条件**:
- バックエンドが起動中
- DBにテストドキュメントが登録済み

**操作手順**:
```bash
locust -f backend/load_tests/locustfile.py \
  --host=http://localhost:8300 \
  --users 50 --spawn-rate 10 \
  --run-time 60s --headless
```

**期待結果**:
- P95応答時間: 3秒以内（チャットAPI除く）
- エラー率: 1%以下
- DB接続エラー: 0件

**検証ポイント**:
- Locustレポートの Failures タブが空
- Avg/P95 response time が基準内

---

### E2E-SCALE-002: 負荷テスト 100人同時

**前提条件**: E2E-SCALE-001 パス済み

**操作手順**:
```bash
locust -f backend/load_tests/locustfile.py \
  --host=http://localhost:8300 \
  --users 100 --spawn-rate 20 \
  --run-time 120s --headless
```

**期待結果**: E2E-SCALE-001 と同じ基準

---

### E2E-SCALE-003: 負荷テスト 1,050人同時

**前提条件**: E2E-SCALE-002 パス済み

**操作手順**:
```bash
locust -f backend/load_tests/locustfile.py \
  --host=http://localhost:8300 \
  --users 1050 --spawn-rate 100 \
  --run-time 300s --headless
```

**期待結果**:
- P95応答時間: 3秒以内（チャットAPI除く）
- エラー率: 1%以下
- DB接続エラー: 0件
- メモリ使用量: 急増しない（OOMなし）

**検証ポイント**:
- チャットAPIはAI呼び出しがあるため5秒以内を許容
- 統計APIのP95が1秒以内（SQL最適化の効果確認）
