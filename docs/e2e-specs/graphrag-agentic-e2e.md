# E2Eテスト仕様書: GraphRAG + Agentic RAG

> **作成日**: 2026-02-06
> **対象機能**: GraphRAG（LightRAG）+ Agentic RAG（LangGraph）
> **テスト対象**: チャット画面（P-001）、ナレッジ管理画面（A-002）

---

## テストケース一覧

| ID | シナリオ | フロー内容 | 期待結果 |
|----|---------|-----------|---------|
| E2E-GR-001 | Agentic RAGチャットフロー | 質問送信→進捗表示→回答+出典 | 各ステップの進捗が表示され、回答と参照元が正しく表示される |
| E2E-GR-002 | GraphRAG関係性質問フロー | 関係性質問→グラフ検索→回答+エンティティ表示 | グラフ経由で関係性を辿った回答が得られる |
| E2E-GR-003 | 複合質問の分解・統合フロー | 複数要素含む質問→分解→統合回答 | 質問が適切に分解され、統合された回答が得られる |
| E2E-GR-004 | 再検索フロー（情報不足→再検索→回答） | 質問→初回検索→不十分判定→再検索→回答 | 最大3回まで再検索し、情報を補完して回答 |
| E2E-GR-005 | 回答不可能な質問のガードレールフロー | 回答困難な質問→3回再検索失敗→ガードレール | 「情報がありません」と明確に回答 |
| E2E-GR-006 | タイムアウト→フォールバックフロー | 質問→15秒経過→既存RAGフォールバック | タイムアウト後、既存RAGで回答が得られる |
| E2E-GR-007 | ドキュメントアップロード→GraphRAG構築フロー | アップロード→非同期グラフ構築→completed | グラフ構築が非同期で完了し、検索可能になる |
| E2E-GR-008 | 部門別アクセス制御（GraphRAG含む）フロー | 他部門ドキュメント→質問→自部門のみ回答 | GraphRAGでも部門制御が正しく機能する |

---

## 詳細シナリオ

### E2E-GR-001: Agentic RAGチャットフロー（基本動作）

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内に「就業規則.pdf」「経費精算マニュアル.pdf」がアップロード済み
- GraphRAG構築済み（graph_build_status = 'completed'）

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「有給休暇の取得条件は？」と入力
3. 送信ボタンをクリック

**期待結果**:
- ストリーミング中に以下のステップ進捗が表示される:
  - 「質問を分析中...」（Analyzer）
  - 「関連情報を検索中...」（Retriever: pgvector + GraphRAG）
  - 「情報の関連性を評価中...」（Grader）
  - 「回答を生成中...」（Generator: Claude Sonnet）
- 回答が段階的に表示される（ストリーミング）
- 回答下部に参照元ドキュメント「就業規則.pdf」のリンクが表示される
- 左サイドバーの会話履歴に質問が追加される

**検証ポイント**:
- [ ] 各ステップの進捗表示が正しく切り替わる
- [ ] 回答が関連ドキュメントに基づいている
- [ ] 参照元リンクをクリックすると該当ドキュメント詳細に遷移する
- [ ] フィードバックボタン（Good/Bad）が表示される

---

### E2E-GR-002: GraphRAG関係性質問フロー

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内に「組織図.pdf」「プロジェクト計画書.pdf」がアップロード済み
- GraphRAG構築済み（エンティティ: 「田中部長」「営業部」「予算500万円」など）

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「田中部長のチームのプロジェクト予算は？」と入力
3. 送信ボタンをクリック

**期待結果**:
- ストリーミング中に「関連情報を検索中...」で GraphRAG が動作
- 回答に「田中部長」→「営業部」→「予算500万円」の関係性を辿った内容が含まれる
- 参照元として「組織図.pdf」「プロジェクト計画書.pdf」が表示される
- 回答に具体的な金額（500万円）が含まれる

**検証ポイント**:
- [ ] GraphRAG経由でエンティティ間の関係性が正しく取得されている
- [ ] 複数ドキュメントにまたがる情報が統合されている
- [ ] 参照元が複数表示される
- [ ] 数値情報が正確に抽出されている

---

### E2E-GR-003: 複合質問の分解・統合フロー

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内に「就業規則.pdf」「経費精算マニュアル.pdf」「福利厚生ガイド.pdf」がアップロード済み

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「有給休暇の日数と交通費の上限金額、社員食堂の利用方法を教えて」と入力
3. 送信ボタンをクリック

**期待結果**:
- 「質問を分析中...」で質問が以下に分解される:
  - 「有給休暇の日数」
  - 「交通費の上限金額」
  - 「社員食堂の利用方法」
- 回答が3つの要素すべてを含む統合された形式で表示される
- 参照元として「就業規則.pdf」「経費精算マニュアル.pdf」「福利厚生ガイド.pdf」が表示される

**検証ポイント**:
- [ ] 質問が適切に分解されている（Analyzer）
- [ ] 各要素に対して適切なドキュメントが検索されている
- [ ] 統合された回答が論理的に整理されている
- [ ] すべての参照元が表示されている

---

### E2E-GR-004: 再検索フロー（情報不足→再検索→回答）

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内に「経費精算マニュアル.pdf」がアップロード済み
- 質問に対して初回検索では情報が不十分な状況

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「出張時の新幹線グリーン車の利用条件」と入力
3. 送信ボタンをクリック

**期待結果**:
- 初回検索後、「情報の関連性を評価中...」で不十分と判定
- 「追加情報を検索中...（1回目）」と表示される
- Query Rewriter により改善されたクエリで再検索
- 最大3回までリトライし、適切な情報が得られたら回答を生成
- 参照元として「経費精算マニュアル.pdf」が表示される

**検証ポイント**:
- [ ] 初回検索で不十分と判定されている（Grader）
- [ ] 再検索の進捗が表示される（「追加情報を検索中...」）
- [ ] Query Rewriter により改善されたクエリが使用されている
- [ ] 最終的に適切な回答が得られる
- [ ] 最大3回までしかリトライしない

---

### E2E-GR-005: 回答不可能な質問のガードレールフロー

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内に社内規定関連のドキュメントのみ存在

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「東京オリンピックの開催年は？」と入力（社内ナレッジと無関係）
3. 送信ボタンをクリック

**期待結果**:
- 初回検索後、「情報の関連性を評価中...」で不十分と判定
- 「追加情報を検索中...（1回目）」→「追加情報を検索中...（2回目）」→「追加情報を検索中...（3回目）」と表示
- 3回の再検索後、以下のガードレール回答が表示される:
  ```
  申し訳ございませんが、お問い合わせいただいた内容に関する情報が見つかりませんでした。
  事務局（xxxx@example.com）までお問い合わせください。
  ```
- 参照元ドキュメントは表示されない

**検証ポイント**:
- [ ] 3回の再検索が実行される
- [ ] 3回失敗後、ガードレール回答が表示される
- [ ] ハルシネーション（存在しない情報の生成）が発生しない
- [ ] 問い合わせ先が明示されている

---

### E2E-GR-006: タイムアウト→フォールバックフロー

**前提条件**:
- ログイン済み（test@tomoe-faq.local）
- ナレッジDB内にドキュメントがアップロード済み
- Agentic RAG処理が15秒を超える状況（※テストではタイムアウト閾値を短縮するか、重い質問を使用）

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に複雑な質問を入力（例: 「全部門の経費精算ルールと有給休暇の取得条件、社員食堂の利用方法と会議室予約手順を比較して」）
3. 送信ボタンをクリック

**期待結果**:
- Agentic RAG処理が開始される
- 15秒経過後、「処理に時間がかかっているため、簡易モードで回答します」と表示される
- 既存RAG（`/api/chat`）にフォールバックし、回答が生成される
- 回答が表示され、参照元ドキュメントも表示される

**検証ポイント**:
- [ ] 15秒でタイムアウトが発生する
- [ ] フォールバック通知が表示される
- [ ] 既存RAGで回答が正常に生成される
- [ ] エラーが発生せず、ユーザー体験が損なわれない

---

### E2E-GR-007: ドキュメントアップロード→GraphRAG構築フロー

**前提条件**:
- 管理者アカウントでログイン済み（admin@example.com）
- アップロード対象のPDFファイル「新入社員ガイド.pdf」を用意

**操作手順**:
1. ナレッジ管理画面（`/admin/documents`）にアクセス
2. 「ドキュメントをアップロード」ボタンをクリック
3. ファイル選択ダイアログで「新入社員ガイド.pdf」を選択
4. 部門設定で「全社公開」を選択
5. 「アップロード」ボタンをクリック
6. アップロード完了後、ドキュメント一覧に表示されることを確認
7. ドキュメント詳細画面でグラフ構築状態を確認

**期待結果**:
- アップロード直後、ドキュメント一覧にステータス「処理中」で表示される
- graph_build_status が 'pending' → 'building' → 'completed' と遷移する
- 数秒〜数十秒後、ステータスが「完了」に変わる
- ドキュメント詳細画面でグラフ構築完了が確認できる
- チャット画面で「新入社員ガイド.pdf」に関する質問が可能になる

**検証ポイント**:
- [ ] アップロード処理が正常に完了する
- [ ] 非同期でGraphRAG構築が実行される（`asyncio.create_task`）
- [ ] graph_build_status が正しく遷移する
- [ ] エンティティとリレーションがgraph_entities、graph_relationsテーブルに保存される
- [ ] 構築完了後、GraphRAG検索でエンティティが取得可能になる

---

### E2E-GR-008: 部門別アクセス制御（GraphRAG含む）フロー

**前提条件**:
- 営業部ユーザーでログイン済み（demo@example.com / 営業部）
- ナレッジDB内に以下のドキュメントがアップロード済み:
  - 「営業部マニュアル.pdf」（部門: 営業部のみ）
  - 「人事部規定.pdf」（部門: 人事部のみ）
  - 「全社共通ルール.pdf」（全社公開）
- GraphRAG構築済み（各ドキュメントからエンティティ抽出済み）

**操作手順**:
1. チャット画面（`/`）にアクセス
2. 質問入力欄に「営業目標の設定方法は？」と入力（営業部マニュアルに記載）
3. 送信ボタンをクリックし、回答を確認
4. 質問入力欄に「人事評価の基準は？」と入力（人事部規定に記載）
5. 送信ボタンをクリックし、回答を確認

**期待結果**:
- 1つ目の質問（営業目標）:
  - 回答が正常に表示される
  - 参照元として「営業部マニュアル.pdf」が表示される
- 2つ目の質問（人事評価）:
  - GraphRAG検索で人事部エンティティが除外される
  - pgvector検索でも人事部ドキュメントが除外される
  - 「お問い合わせいただいた内容に関する情報が見つかりませんでした」と回答される
  - または「全社共通ルール.pdf」の一般的な内容のみ回答される

**検証ポイント**:
- [ ] 自部門のドキュメントは正常に検索・回答される
- [ ] 他部門のドキュメントは検索結果から除外される
- [ ] GraphRAG検索でも graph_entity_department テーブルによる制御が機能する
- [ ] 全社公開ドキュメントは検索可能
- [ ] 部門制御によるエラーが発生しない

---

## テスト実行前の準備

### 1. テストデータ準備

以下のドキュメントをナレッジ管理画面からアップロード:

| ファイル名 | 部門設定 | 主要内容 |
|-----------|---------|---------|
| 就業規則.pdf | 全社公開 | 有給休暇、勤務時間、休日等 |
| 経費精算マニュアル.pdf | 全社公開 | 交通費、出張費、領収書提出 |
| 福利厚生ガイド.pdf | 全社公開 | 社員食堂、健康診断、社宅 |
| 組織図.pdf | 全社公開 | 部門構成、担当者名、連絡先 |
| プロジェクト計画書.pdf | 全社公開 | プロジェクト名、予算、期間 |
| 営業部マニュアル.pdf | 営業部のみ | 営業目標、顧客管理、報告書 |
| 人事部規定.pdf | 人事部のみ | 採用基準、評価制度、給与 |

### 2. テストアカウント

| 役割 | メールアドレス | パスワード | 部門 |
|------|---------------|-----------|------|
| 一般ユーザー | test@tomoe-faq.local | TomoeTest2026! | 営業部 |
| 管理者 | admin@example.com | admin123 | 事務局 |
| 営業部ユーザー | demo@example.com | demo123 | 営業部 |
| 人事部ユーザー | tanaka@example.com | tanaka123 | 人事部 |

### 3. 環境変数確認

`.env.local` に以下が設定されていることを確認:

```bash
ANTHROPIC_API_KEY=sk-ant-xxxxx
OPENAI_API_KEY=sk-xxxxx
DATABASE_URL=postgresql://user:pass@host/db
```

### 4. GraphRAG構築確認

ドキュメントアップロード後、以下を確認:

```bash
# バックエンドコンソールで確認
curl -X GET "http://localhost:8432/api/admin/documents/{document_id}/graph-status" \
  -H "Authorization: Bearer {jwt_token}"

# 期待されるレスポンス
{
  "document_id": "xxx",
  "graph_build_status": "completed",
  "entity_count": 25,
  "relation_count": 40
}
```

---

## テスト環境

```yaml
フロントエンド: http://localhost:3247
バックエンド: http://localhost:8432
データベース: PostgreSQL (Neon) + pgvector
```

---

## テスト完了条件

- [ ] 全8シナリオの検証ポイントがすべて合格
- [ ] GraphRAG構築が正常に完了（graph_build_status = 'completed'）
- [ ] Agentic RAGの各ステップ（Analyzer, Retriever, Grader, Generator, Verifier）が正常動作
- [ ] 部門別アクセス制御がGraphRAG検索でも機能
- [ ] タイムアウトフォールバックが正常動作
- [ ] エラーログにクリティカルエラーが存在しない

---

## 注意事項

### テスト実施時の注意
- **E2Eテストでも実認証必須**: 認証スキップ機能は使用禁止
- **フロントエンドのモックも絶対禁止**: 実際のAPIを使用
- **バックエンドのモック絶対禁止**: 本番と同じAzure OpenAI、Claude APIを使用
- **環境変数は .env.local のみ**: .env.test 等は作成しない

### テスト実行順序
1. E2E-GR-007 を最初に実行（ドキュメントアップロード→GraphRAG構築）
2. グラフ構築完了後、E2E-GR-001〜006 を実行
3. E2E-GR-008 は最後に実行（部門制御の確認）

### トラブルシューティング
- **GraphRAG構築が失敗する場合**: バックエンドログで `graph_builder.py` のエラーを確認
- **Agentic RAG がタイムアウトする場合**: 質問内容を簡略化するか、タイムアウト閾値を延長（開発時のみ）
- **部門制御が機能しない場合**: `graph_entity_department` テーブルにエンティティと部門の紐付けが正しく保存されているか確認

---

## 改訂履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-02-06 | 1.0 | 初版作成 |
